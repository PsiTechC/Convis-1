version: '3.8'

services:
  # Redis for campaign system (optional but recommended)
  redis:
    image: redis:7-alpine
    container_name: convis-redis
    restart: unless-stopped
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    networks:
      - convis-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ngrok tunnel for webhooks
  ngrok:
    image: ngrok/ngrok:latest
    container_name: convis-ngrok
    restart: unless-stopped
    command:
      - "http"
      - "api:8000"
    ports:
      - "4040:4040"  # Ngrok web interface
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    networks:
      - convis-network
    depends_on:
      - api

  # FastAPI Backend
  api:
    build:
      context: ./convis-api
      dockerfile: Dockerfile
    container_name: convis-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # MongoDB Configuration
      - MONGODB_URI=${MONGODB_URI}
      - DATABASE_NAME=${DATABASE_NAME}

      # Security
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      # Email Configuration
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASS=${EMAIL_PASS}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USE_SSL=${SMTP_USE_SSL}

      # URLs
      - FRONTEND_URL=${FRONTEND_URL}
      - API_BASE_URL=${API_BASE_URL}
      - BASE_URL=${BASE_URL}
      - CORS_ORIGINS=${CORS_ORIGINS}

      # Redis
      - REDIS_URL=redis://redis:6379

      # Twilio
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Google Calendar
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI}

      # Microsoft Calendar
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID}
      - MICROSOFT_REDIRECT_URI=${MICROSOFT_REDIRECT_URI}

      # Campaign Settings
      - DEFAULT_TIMEZONE=${DEFAULT_TIMEZONE:-Asia/Kolkata}
      - DEFAULT_MAX_ATTEMPTS=${DEFAULT_MAX_ATTEMPTS:-3}
      - DEFAULT_RETRY_DELAYS=${DEFAULT_RETRY_DELAYS:-15,60,1440}

      # Feature Flags
      - ENABLE_CALENDAR_BOOKING=${ENABLE_CALENDAR_BOOKING:-true}
      - ENABLE_POST_CALL_AI=${ENABLE_POST_CALL_AI:-true}
      - ENABLE_AUTO_RETRY=${ENABLE_AUTO_RETRY:-true}
      - CAMPAIGN_DISPATCH_INTERVAL_SECONDS=${CAMPAIGN_DISPATCH_INTERVAL_SECONDS:-1}

      # Celery
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

      - ENVIRONMENT=production
      - PORT=8000
      - HOST=0.0.0.0
    volumes:
      - api-uploads:/app/uploads
      - api-chroma:/app/chroma_db
      - api-logs:/app/logs
    networks:
      - convis-network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Next.js Frontend
  web:
    build:
      context: ./convis-web
      dockerfile: Dockerfile
    container_name: convis-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NODE_ENV=production
    depends_on:
      api:
        condition: service_healthy
    networks:
      - convis-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy (optional)
  nginx:
    image: nginx:alpine
    container_name: convis-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - api
      - web
    networks:
      - convis-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

# Persistent volumes for data
volumes:
  redis-data:
    driver: local
  api-uploads:
    driver: local
  api-chroma:
    driver: local
  api-logs:
    driver: local
  nginx-logs:
    driver: local

# Network for inter-container communication
networks:
  convis-network:
    driver: bridge
